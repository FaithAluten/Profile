name: Convert Clash Rules to Loon

# 触发条件：当 Clash/Rule 下的 yaml 文件发生 push 操作时触发
on:
  push:
    paths:
      - 'Clash/Rule/*.yaml'
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run Conversion Script
        run: |
          import os

          # 定义文件对应关系
          files = ['Block', 'Direct', 'GFW']
          
          # 定义路径
          base_dir = os.getcwd()
          clash_dir = os.path.join(base_dir, 'Clash/Rule')
          loon_dir = os.path.join(base_dir, 'Loon/Rule')

          # 确保输出目录存在
          if not os.path.exists(loon_dir):
              os.makedirs(loon_dir)

          for filename in files:
              clash_file = os.path.join(clash_dir, f"{filename}.yaml")
              loon_file = os.path.join(loon_dir, f"{filename}.lsr")

              if os.path.exists(clash_file):
                  print(f"Processing {filename}...")
                  with open(clash_file, 'r', encoding='utf-8') as f_in, \
                       open(loon_file, 'w', encoding='utf-8') as f_out:
                      
                      for line in f_in:
                          stripped_line = line.strip()
                          
                          # 跳过空行
                          if not stripped_line:
                              continue
                          
                          # 跳过 'payload:' 行
                          if stripped_line.startswith('payload:'):
                              continue
                          
                          # 处理规则行：去除开头的 '- ' 或 '-'
                          if stripped_line.startswith('-'):
                              # 去掉开头的 '-'，然后再去掉前后的空格
                              rule = stripped_line[1:].strip()
                              f_out.write(f"{rule}\n")
                          else:
                              # 如果有不带 '-' 的行（虽然Clash规则通常都有），直接写入
                              f_out.write(f"{stripped_line}\n")
                  print(f"Generated {loon_file}")

        shell: python

      - name: Commit and Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 添加生成的文件
          git add Loon/Rule/*.lsr
          
          # 检查是否有变更，有变更才提交
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto convert Clash rules to Loon format"
            git push
          fi
